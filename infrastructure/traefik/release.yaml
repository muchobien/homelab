apiVersion: helm.toolkit.fluxcd.io/v2beta1
kind: HelmRelease
metadata:
  name: traefik
  namespace: flux-system
spec:
  chart:
    spec:
      chart: traefik
      sourceRef:
        kind: HelmRepository
        name: traefik
      version: 20.8.0
  interval: 1h0m0s
  releaseName: traefik
  targetNamespace: traefik
  install:
    crds: Create
  upgrade:
    crds: CreateReplace
  values:
    providers:
      kubernetesCRD:
        enabled: true
        allowCrossNamespace: true
    service:
      enabled: false
    persistence:
      enabled: true
      storageClass: longhorn
    env:
      - name: CF_API_KEY
        valueFrom:
          secretKeyRef:
            name: traefik-secrets
            key: apiKey
      - name: CF_API_EMAIL
        valueFrom:
          secretKeyRef:
            name: traefik-secrets
            key: email
      - name: WILDCARD_DOMAIN
        valueFrom:
          secretKeyRef:
            name: traefik-secrets
            key: wildcardDomain
    additionalArguments:
      - --entrypoints.websecure.http.tls.certresolver=letsencrypt
      - --certificatesresolvers.letsencrypt.acme.storage=/data/acme.json
      - --certificatesresolvers.letsencrypt.acme.email=$(CF_API_EMAIL)
      - --certificatesresolvers.letsencrypt.acme.dnschallenge.provider=cloudflare
      - --certificatesresolvers.letsencrypt.acme.dnschallenge.resolvers=1.1.1.1:53,1.0.0.1:53
      - --certificatesresolvers.letsencrypt.acme.dnschallenge.delaybeforecheck=90
      - --entrypoints.websecure.http.tls.domains[0].main=$(WILDCARD_DOMAIN)
      - --entrypoints.websecure.http.tls.domains[0].sans=$(WILDCARD_DOMAIN)
    resources:
      requests:
        cpu: "100m"
        memory: "50Mi"
      limits:
        cpu: "300m"
        memory: "150Mi"
    initContainers:
      - name: volume-permissions
        image: busybox:1.35.0
        command:
          [
            "sh",
            "-c",
            "touch /data/acme.json && chmod -Rv 600 /data/* && chown 65532:65532 /data/acme.json",
          ]
        volumeMounts:
          - name: data
            mountPath: /data
